<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>RPG DM Station - V42 Audio FX</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
  /* --- BASICS --- */
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
  body { margin: 0; padding: 0; background: #050505; overflow: hidden; font-family: 'Segoe UI', Roboto, sans-serif; color: #e0e0e0; }
  
  /* --- LOGIN --- */
  #login-screen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
  .login-box { background: #111; border: 1px solid #333; padding: 30px; border-radius: 12px; width: 100%; max-width: 400px; text-align: center; }
  .room-input { width: 100%; padding: 15px; margin: 20px 0; background: #222; border: 2px solid #444; color: #fff; font-size: 18px; text-align: center; border-radius: 8px; outline: none; text-transform: lowercase; }
  .action-btn { width: 100%; padding: 15px; margin: 5px 0; font-size: 16px; font-weight: bold; cursor: pointer; border: none; border-radius: 8px; color: #fff; transition: 0.2s; }
  .btn-tv-mode { background: #2980b9; border-bottom: 4px solid #1a5276; }
  .btn-remote-mode { background: #27ae60; border-bottom: 4px solid #196f3d; }

  /* --- AUDIO UNLOCK --- */
  #audio-unlock { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.95); z-index: 20000; display: none; flex-direction: column; align-items: center; justify-content: center; color: #fff; text-align: center; }
  .btn-unlock { padding: 20px 40px; font-size: 24px; background: #27ae60; color: #fff; border: none; border-radius: 50px; cursor: pointer; animation: pulseBtn 2s infinite; }
  @keyframes pulseBtn { 0% { transform: scale(1); } 50% { transform: scale(1.05); box-shadow: 0 0 20px #27ae60; } 100% { transform: scale(1); } }

  /* --- STATUS BAR --- */
  #connection-status { position: fixed; top: 0; left: 0; width: 100%; height: 4px; z-index: 10000; background: #e74c3c; transition: background 0.3s; }
  #connection-status.online { background: #2ecc71; box-shadow: 0 0 10px #2ecc71; }
  #connection-status.reconnecting { background: #f1c40f; }

  /* --- LAYOUT & FX LAYERS --- */
  #game-container { position: relative; width: 100vw; height: 100vh; display: none; overflow: hidden; }
  
  #mapa-visual { width: 100%; height: 100%; background-size: cover; background-position: center; transition: background-image 0.5s ease-in-out, filter 0.5s ease; }
  .modo-dia #mapa-visual { filter: brightness(1) contrast(1.05); }
  .modo-noite #mapa-visual { filter: brightness(0.5) contrast(1.2) hue-rotate(-15deg); }
  .modo-invertido #mapa-visual { filter: invert(1) hue-rotate(180deg) brightness(0.8) contrast(1.3); }

  /* FX */
  #fx-layer { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index: 15; }
  @keyframes flashFx { 0% { background: rgba(255,255,255,0); } 10% { background: rgba(255,255,255,1); } 100% { background: rgba(255,255,255,0); } }
  .fx-flash { animation: flashFx 0.5s ease-out; }
  @keyframes shakeFx { 
    0% { transform: translate(0,0); } 10% { transform: translate(-10px,-10px); } 20% { transform: translate(10px,10px); } 
    30% { transform: translate(-10px,10px); } 40% { transform: translate(10px,-10px); } 50% { transform: translate(-10px,0); } 
    100% { transform: translate(0,0); } 
  }
  .fx-shake { animation: shakeFx 0.5s ease-in-out; }
  .fx-blood { box-shadow: inset 0 0 100px 50px rgba(180, 0, 0, 0.6); animation: pulseBlood 2s infinite; }
  @keyframes pulseBlood { 0% { box-shadow: inset 0 0 100px 50px rgba(180, 0, 0, 0.4); } 50% { box-shadow: inset 0 0 150px 80px rgba(220, 0, 0, 0.7); } 100% { box-shadow: inset 0 0 100px 50px rgba(180, 0, 0, 0.4); } }

  /* HANDOUT OVERLAY */
  #handout-layer { 
    position: fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.9); 
    z-index: 100; display:none; flex-direction:column; align-items:center; justify-content:center; 
    opacity: 0; transition: opacity 0.5s;
  }
  #handout-layer.visivel { display: flex; opacity: 1; }
  #handout-img { max-width: 95%; max-height: 95%; border: 2px solid #fff; box-shadow: 0 0 30px #000; }

  /* --- HUD --- */
  #hud-mestre { position: absolute; top: 0; right: 0; width: 320px; height: 100%; background: rgba(18, 18, 18, 0.98); border-left: 1px solid #333; display: flex; flex-direction: column; z-index: 50; transition: transform 0.3s ease; }
  #hud-mestre.oculto { transform: translateX(100%); }
  .hud-header { padding: 10px; background: #151515; border-bottom: 1px solid #333; flex-shrink: 0; }
  .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .btn-gear { background: none; border: none; color: #555; font-size: 20px; padding: 0 10px; cursor: pointer; }
  .btn-gear.ativo { color: #fff; }
  .hud-content { flex: 1; overflow-y: auto; padding: 10px; }
  .hud-footer { padding: 10px; background: #151515; border-top: 1px solid #333; flex-shrink: 0; }

  /* --- CONTROLES --- */
  .dice-wrapper { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; background: #222; padding: 8px; border-radius: 8px; border: 1px solid #333; }
  .btn-dice { flex: 1; padding: 12px; background: #333; color: #fff; border: 1px solid #555; border-radius: 6px; font-weight: bold; font-size: 16px; cursor: pointer; }
  .btn-dice:disabled { opacity: 0.5; cursor: not-allowed; }
  #dice-display { width: 50px; font-size: 28px; font-weight: bold; text-align: center; color: #f1c40f; }

  .grid-maps { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin-bottom: 8px; }
  .grid-actions { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; }
  #btn-mod-d, #btn-mod-n, #btn-mod-i { grid-column: span 2; }
  #btn-music, #btn-tv-vis { grid-column: span 3; }

  /* FX GRID */
  .grid-fx { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 5px; margin-bottom: 15px;}
  .btn-fx { padding: 10px; background: #444; border: 1px solid #666; color: #fff; border-radius: 6px; cursor: pointer; font-size: 14px; }
  .btn-fx:active { background: #666; transform: scale(0.95); }
  .btn-fx.blood-on { background: #c0392b; border-color: #e74c3c; color: #fff; box-shadow: 0 0 10px #c0392b; }

  /* SELECT & SHOW WRAPPERS */
  .control-wrapper { display: flex; gap: 5px; margin-top: 5px; background: #222; padding: 5px; border-radius: 6px; border: 1px solid #333; align-items: center; }
  .label-tiny { font-size: 10px; color: #888; width: 50px; text-transform: uppercase; font-weight: bold; }
  .select-box { flex: 1; background: #111; border: 1px solid #444; color: #ccc; padding: 8px; border-radius: 4px; font-size: 12px; }
  .btn-show { padding: 8px 12px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; }
  .btn-show:active { background: #2980b9; }
  .btn-hide { padding: 8px; background: #442222; border: 1px solid #c0392b; color: #fff; border-radius: 4px; cursor: pointer; font-size: 11px; }

  .btn-ctrl { padding: 12px 0; background: #2a2a2a; border: 1px solid #444; color: #888; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold; transition: 0.1s; }
  .btn-ctrl.active { background: #3498db; color: #fff; border-color: #5dade2; }
  .btn-ctrl.tv-active { background: #27ae60; color: #fff; border-color: #2ecc71; }
  .btn-ctrl.music-on { background: #2ecc71; color: #fff; border-color: #27ae60; }
  .btn-ctrl.music-off { background: #e74c3c; color: #fff; border-color: #c0392b; }

  /* --- CARDS --- */
  .mestre-card { background: #222; border-radius: 8px; padding: 10px; margin-bottom: 10px; border-left: 4px solid #555; position: relative; }
  .card-top { display: flex; justify-content: space-between; margin-bottom: 5px; }
  .input-nome { background: transparent; border: none; color: #fff; font-weight: bold; font-size: 16px; width: 100%; outline: none; }
  .input-classe { background: transparent; border: none; color: #888; font-size: 12px; width: 100%; outline: none; text-transform: uppercase; }
  .bar-container { margin: 8px 0; }
  .hp-bar-bg { background: #111; height: 10px; border-radius: 5px; overflow: hidden; margin-bottom: 3px; }
  .mp-bar-bg { background: #111; height: 6px; border-radius: 3px; overflow: hidden; } 
  .hp-bar-fill { height: 100%; transition: width 0.3s; }
  .mp-bar-fill { height: 100%; transition: width 0.3s; background: #3498db; box-shadow: 0 0 5px #3498db; }
  .hp-verde { background: #2ecc71; } .hp-amarelo { background: #f1c40f; } .hp-vermelho { background: #e74c3c; }
  .status-text-row { display: flex; justify-content: space-between; font-size: 11px; color: #aaa; margin-bottom: 2px; }
  .card-actions { display: flex; gap: 3px; margin-top: 5px; }
  .btn-dmg { flex: 1; padding: 8px 0; background: #2a2a2a; border: 1px solid #444; color: #fff; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; }
  .btn-dmg.heal { color: #2ecc71; border-color: #27ae60; } 
  .btn-dmg.harm { color: #e74c3c; border-color: #c0392b; }
  .btn-dmg.mana-add { color: #3498db; border-color: #2980b9; }
  .btn-dmg.mana-sub { color: #5dade2; border-color: #2980b9; opacity: 0.8; }
  .card-settings { display: flex; gap: 5px; margin-top: 8px; }
  .select-style { flex: 1; background: #151515; border: 1px solid #333; color: #aaa; padding: 8px; border-radius: 4px; font-size: 12px; }

  /* --- TV SPECIFIC --- */
  body.remote-active #hud-mestre { width: 100vw; height: 100vh; position: fixed; left: 0; top: 0; border: none; transform: none !important; }
  body.remote-active #mapa-visual, body.remote-active #tv-layer, body.remote-active #tv-dice-overlay, body.remote-active #handout-layer, body.remote-active #fx-layer { display: none !important; }
  #tv-layer { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 20; display: none; }
  #tv-layer.visivel { display: block; }
  .zone { position: absolute; display: flex; align-items: center; justify-content: center; gap: 20px; pointer-events: none; }
  #zone-sul { bottom: 30px; left: 0; width: 100%; } 
  #zone-norte { top: 30px; left: 0; width: 100%; transform: rotate(180deg); }
  #zone-oeste { top: 0; left: 30px; height: 100%; flex-direction: column; }
  #zone-oeste .tv-card { transform: rotate(90deg); margin: 60px 0; }
  #zone-leste { top: 0; right: 30px; height: 100%; flex-direction: column; }
  #zone-leste .tv-card { transform: rotate(-90deg); margin: 60px 0; }
  
  .tv-card { position: relative; pointer-events: auto; width: 260px; flex-shrink: 0; background: rgba(0, 0, 0, 0.9); border: 2px solid #666; border-radius: 12px; padding: 15px; box-shadow: 0 0 30px rgba(0,0,0,0.8); color: #fff; }
  .tv-name { font-size: 20px; font-weight: bold; margin-bottom: 5px; }
  .tv-status { text-align: center; font-weight: bold; font-size: 16px; margin-top: 10px; padding-top: 5px; border-top: 1px solid #444; color: #ddd; text-transform: uppercase; }
  .tv-vals { display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; margin-bottom: 2px; }
  .tv-hp-val { color: #2ecc71; } .tv-mp-val { color: #3498db; }

  /* FLOATING TEXT */
  .float-text { position: absolute; left: 50%; top: 0; transform: translate(-50%, 0); font-size: 32px; font-weight: bold; pointer-events: none; animation: floatUp 1.5s forwards; text-shadow: 0 0 5px #000; z-index: 10; }
  .float-text.heal { color: #2ecc71; } .float-text.harm { color: #e74c3c; } .float-text.mana { color: #3498db; }
  @keyframes floatUp { 0% { top: 0; opacity: 1; transform: translate(-50%, 0) scale(1); } 100% { top: -80px; opacity: 0; transform: translate(-50%, 0) scale(1.5); } }

  /* DADOS ANIM */
  #tv-dice-overlay { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); width: 300px; height: 300px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.95); border: 4px solid #888; border-radius: 50%; font-size: 120px; font-weight: 900; color: #fff; z-index: 9999; opacity: 0; pointer-events: none; transition: transform 0.1s; }
  #tv-dice-overlay.rolling { opacity: 1; transform: translate(-50%, -50%) scale(1); animation: pulseRoll 0.1s infinite alternate; border-color: #fff; color: #fff; }
  #tv-dice-overlay.impact { transform: translate(-50%, -50%) scale(1.2); border-width: 8px; text-shadow: 0 0 30px currentColor; transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
  #tv-dice-overlay.impact.crit-20 { border-color: #f1c40f; color: #f1c40f; box-shadow: 0 0 60px #2ecc71; }
  #tv-dice-overlay.impact.crit-1  { border-color: #c0392b; color: #e74c3c; box-shadow: 0 0 60px #c0392b; animation: shake 0.4s ease-in-out; }
  #tv-dice-overlay.impact.normal  { border-color: #3498db; color: #fff; box-shadow: 0 0 40px #3498db; }
  @keyframes pulseRoll { from { transform: translate(-50%, -50%) scale(0.9); } to { transform: translate(-50%, -50%) scale(1.0); } }
  @keyframes shake { 0%, 100% { transform: translate(-50%, -50%) scale(1.2); } 25% { transform: translate(-52%, -50%) scale(1.2); } 75% { transform: translate(-48%, -50%) scale(1.2); } }
</style>
</head>
<body>

<datalist id="lista-classes"></datalist>
<div id="connection-status"></div>

<div id="audio-unlock">
  <h1 style="margin-bottom:30px;">üñ•Ô∏è MODO TV</h1>
  <button class="btn-unlock" onclick="unlockAudio()">üîä CLIQUE PARA ATIVAR O SOM</button>
</div>
<div id="handout-layer"><img id="handout-img" src="" alt="Handout"></div>
<div id="fx-layer"></div>

<div id="login-screen">
  <div class="login-box">
    <h2 style="margin-top:0; color:#fff;">RPG STATION</h2>
    <p style="color:#aaa; font-size:14px;">Sala:</p>
    <input type="text" id="room-name" class="room-input" placeholder="ex: mesa" value="mesa">
    <button class="action-btn btn-tv-mode" onclick="startApp('tv')">üì∫ TV</button>
    <button class="action-btn btn-remote-mode" onclick="startApp('remote')">üì± CONTROLE</button>
  </div>
</div>

<div id="game-container">
  <div id="mapa-visual"></div>
  <div id="tv-layer">
    <div id="zone-norte" class="zone"></div>
    <div id="zone-sul" class="zone"></div>
    <div id="zone-leste" class="zone"></div>
    <div id="zone-oeste" class="zone"></div>
  </div>
  <div id="tv-dice-overlay"></div>

  <div id="hud-mestre">
    <div class="hud-header">
      <div class="header-top">
        <span style="font-weight:bold; color:#fff;">CONTROLE</span>
        <button class="btn-gear" id="btn-editar" onclick="toggleEdicao()">‚öôÔ∏è</button>
      </div>

      <div class="dice-wrapper">
        <button class="btn-dice" id="btn-dice-roll" onclick="rolarD20()">üé≤ ROLAR D20</button>
        <div id="dice-display">-</div>
      </div>

      <div class="grid-fx">
        <button class="btn-fx" onclick="triggerFx('shake')">üí• TREMOR</button>
        <button class="btn-fx" onclick="triggerFx('flash')">‚ö° FLASH</button>
        <button class="btn-fx" id="btn-blood" onclick="toggleBlood()">ü©∏ SANGUE</button>
      </div>

      <div class="control-wrapper">
        <span class="label-tiny">CARTA</span>
        <select id="sel-handout" class="select-box"></select>
        <button class="btn-show" onclick="showHandoutFromList()">üëÅÔ∏è</button>
        <button class="btn-hide" onclick="hideHandout()">‚úñ</button>
      </div>

      <div class="control-wrapper">
        <span class="label-tiny">INIMIGO</span>
        <select id="sel-enemy" class="select-box"></select>
        <button class="btn-show" onclick="showEnemyFromList()">üëÅÔ∏è</button>
        <button class="btn-hide" onclick="hideHandout()">‚úñ</button>
      </div>

      <div class="grid-maps" style="margin-top:10px;">
        <button class="btn-ctrl" id="btn-map-1" onclick="mudarCenario('1')">1</button>
        <button class="btn-ctrl" id="btn-map-2" onclick="mudarCenario('2')">2</button>
        <button class="btn-ctrl" id="btn-map-3" onclick="mudarCenario('3')">3</button>
        <button class="btn-ctrl" id="btn-map-4" onclick="mudarCenario('4')">4</button>
        <button class="btn-ctrl" id="btn-map-5" onclick="mudarCenario('5')">5</button>
        <button class="btn-ctrl" id="btn-map-6" onclick="mudarCenario('6')">6</button>
      </div>
      
      <div class="grid-actions">
        <button class="btn-ctrl" id="btn-mod-d" onclick="mudarModo('d')">‚òÄÔ∏è Dia</button>
        <button class="btn-ctrl" id="btn-mod-n" onclick="mudarModo('n')">üåô Noite</button>
        <button class="btn-ctrl" id="btn-mod-i" onclick="mudarModo('i')">üëπ Inv.</button>
        <button class="btn-ctrl" id="btn-music" onclick="toggleMusic()">üéµ Som</button>
        <button class="btn-ctrl" id="btn-tv-vis" onclick="toggleTvVisibility()">üëÅÔ∏è TV</button>
      </div>
    </div>

    <div class="hud-content" id="lista-mestre"></div>

    <div class="hud-footer">
      <div style="display:flex; gap:10px;">
        <button class="btn-ctrl" onclick="adicionarJogador()" style="flex:1;">+ Novo</button>
        <button class="btn-ctrl" onclick="resetarJogo()" style="flex:1; background:#442222; border-color:#c0392b;">Reset</button>
      </div>
    </div>
  </div>
</div>

<script>
/* CONFIGURA√á√ÉO */
const CONFIG = {
  mapas: {
    '1': { img: { d: 'https://i.imgur.com/t70Pggh.jpeg', n: 'https://i.imgur.com/YG1uink.jpeg', i: 'https://i.imgur.com/BSpsexk.jpeg' }, audio: { d: 'https://files.catbox.moe/2ztb9c.mp3', n: 'https://seusite.com/musica_noite.mp3', i: 'https://seusite.com/musica_batalha.mp3' } },
    '2': { img: { d: 'https://i.imgur.com/l33W47q.jpeg', n: 'https://i.imgur.com/pYwiL52.jpeg', i: 'https://i.imgur.com/VHD9fQs.jpeg' }, audio: { d: 'https://files.catbox.moe/e5f1s7.mp3', n: '', i: '' } },
    '3': { img: { d: 'https://i.imgur.com/c0yg80W.jpeg', n: 'https://i.imgur.com/W54GwTN.jpeg', i: 'https://i.imgur.com/mvmS1Un.jpeg' }, audio: { d: '', n: '', i: '' } },
    '4': { img: { d: 'https://i.imgur.com/Ixd3Orw.jpeg', n: 'https://i.imgur.com/SGDOfYS.jpeg', i: 'https://i.imgur.com/oQn27ML.jpeg' }, audio: { d: '', n: '', i: '' } },
    '5': { img: { d: 'https://i.imgur.com/snuoKNG.jpeg', n: 'https://i.imgur.com/6cOkclv.jpeg', i: 'https://i.imgur.com/eH3gWOm.png' }, audio: { d: '', n: '', i: '' } },
    '6': { img: { d: 'https://i.imgur.com/snuoKNG.jpeg', n: 'https://i.imgur.com/6cOkclv.jpeg', i: 'https://i.imgur.com/eH3gWOm.png' }, audio: { d: '', n: '', i: '' } },
    '7': { img: { d: 'https://i.imgur.com/l33W47q.jpeg', n: '', i: '' }, audio: { d: '', n: '', i: '' } }
  },
  
  // === LINKS DOS EFEITOS SONOROS (Preencha com seus links) ===
  sfx: {
    'dano': 'https://files.catbox.moe/04s1r0.mp3',   // Ex: https://files.catbox.moe/punch.mp3
    'cura': 'https://files.catbox.moe/5smutd.mp3',   // Ex: https://files.catbox.moe/heal.mp3
    'mana': 'https://files.catbox.moe/b6tc2t.mp3',   // Ex: https://files.catbox.moe/mana.mp3
    'tremor': 'https://files.catbox.moe/50fhvn.mp3', // Ex: https://files.catbox.moe/rumble.mp3
    'flash': 'https://files.catbox.moe/w7i7zb.mp3',  // Ex: https://files.catbox.moe/thunder.mp3
    'carta': 'https://files.catbox.moe/sieyxb.mp3',  // Ex: https://files.catbox.moe/paper.mp3
    'latido': 'https://files.catbox.moe/9qp44s.mp3',  // Ex: https://files.catbox.moe/paper.mp3
    'inimigo': 'https://files.catbox.moe/xd8amy.mp3' // Ex: https://files.catbox.moe/roar.mp3
  },

  handouts: {
    'Carta': 'https://i.imgur.com/05da1cq.png',
    'Mapa': 'https://i.imgur.com/zfDexGy.png',
    'Dispositivo': 'https://i.imgur.com/s6Q6ptM.png',
    'equipamento': 'https://i.imgur.com/xiiWbO5.png',
  },

  inimigos: {
    'A criatura portal': 'https://i.imgur.com/DBOpKIP.png',
    'Sombra rastejante': 'https://i.imgur.com/AifuiCI.jpeg',
    'exame': 'https://i.imgur.com/mmpm2hP.png',
    'ca√ßador': 'https://i.imgur.com/QbiPg7T.png',
    'experiemnto': 'https://i.imgur.com/tfm9Qla.png',
	'observador': 'https://i.imgur.com/1sLQjR3.png',
  },

  classesPadrao: ["Guerreiro", "Mago", "Ladino", "Cl√©rigo", "B√°rbaro", "Paladino", "Ranger", "Feiticeiro", "Bardo", "Druida", "Monge", "Bruxo", "Art√≠fice"],
  listaStatus: [ { valor: "", label: "üü¢ Saud√°vel" }, { valor: "cansado", label: "üü° Cansado" }, { valor: "critico", label: "üî¥ Debilitado" }, { valor: "caido", label: "üíÄ Ca√≠do" }, { valor: "poison", label: "‚ò†Ô∏è Envenenado" }, { valor: "invis", label: "üëª Invis√≠vel" } ],
  jogadores: [ { nome: "Jogador 1", classe: "Guerreiro", hpMax: 50, hpAtual: 50, mpMax: 20, mpAtual: 20, status: "", posicao: "sul" }, { nome: "Jogador 2", classe: "Mago", hpMax: 30, hpAtual: 30, mpMax: 50, mpAtual: 50, status: "", posicao: "norte" } ],
  volume: 0.5, saveKey: "rpg_dm_v42_audiofx"
};

const ui = {
  mestreList: document.getElementById("lista-mestre"),
  zones: { norte: document.getElementById("zone-norte"), sul: document.getElementById("zone-sul"), leste: document.getElementById("zone-leste"), oeste: document.getElementById("zone-oeste") },
  tvLayer: document.getElementById("tv-layer"), diceDisplay: document.getElementById("dice-display"), tvDiceOverlay: document.getElementById("tv-dice-overlay"),
  visual: document.getElementById("mapa-visual"), audioPlayers: {}, btnEdit: document.getElementById("btn-editar"), connStatus: document.getElementById("connection-status"),
  handoutLayer: document.getElementById("handout-layer"), handoutImg: document.getElementById("handout-img"), fxLayer: document.getElementById("fx-layer")
};

let estadoAtual = { mapa: '1', modo: 'd', audio: true, blood: false }; 
let tvVisible = false; let lastDiceRoll = { val: 0, id: 0 }; 
let isRemote = false; let modoEdicao = false;
let faixaAtiva = 'A'; let trilhaAtualUrl = "";
let peer = null; let conn = null; let roomName = ""; let peerIdPrefix = "rpg-sys-v42-";
let diceTimeout = null; let diceInterval = null; let isDiceRolling = false;

ui.faixaA = new Audio(); ui.faixaA.loop = true; ui.faixaA.volume = 0;
ui.faixaB = new Audio(); ui.faixaB.loop = true; ui.faixaB.volume = 0;

/* --- INIT --- */
async function startApp(mode) {
  roomName = document.getElementById("room-name").value.trim().toLowerCase() || "mesa";
  document.getElementById("login-screen").style.display = "none";
  isRemote = (mode === 'remote');
  if (!isRemote) { document.getElementById("audio-unlock").style.display = "flex"; } else { document.getElementById("game-container").style.display = "block"; setupPeer(null, peerIdPrefix + roomName); }
  window.focus(); try { if (navigator.wakeLock) await navigator.wakeLock.request('screen'); } catch(e){}
  populateSelect('sel-handout', CONFIG.handouts);
  populateSelect('sel-enemy', CONFIG.inimigos);
  carregarJogo(); updateUI();
  setInterval(() => { if (conn && conn.open) conn.send({ heartbeat: true }); }, 2000);
}

function unlockAudio() {
  ui.faixaA.play().then(() => ui.faixaA.pause()); ui.faixaB.play().then(() => ui.faixaB.pause());
  document.getElementById("audio-unlock").style.display = "none";
  document.getElementById("game-container").style.display = "block";
  setupPeer(peerIdPrefix + roomName, null); carregarCena();
}

function populateSelect(id, dataObj) {
  const sel = document.getElementById(id);
  sel.innerHTML = '<option value="">Selecione...</option>';
  for (const key in dataObj) { sel.innerHTML += `<option value="${dataObj[key]}">${key}</option>`; }
}

/* --- CONNECT --- */
function setupPeer(myId, connectToId) {
  if (peer) peer.destroy(); peer = new Peer(myId);
  peer.on('open', (id) => { ui.connStatus.className = 'online'; if(connectToId) connect(connectToId); });
  peer.on('connection', (c) => handleConnection(c));
  peer.on('error', (err) => { if(err.type === 'unavailable-id') { alert("Sala ocupada!"); location.reload(); } ui.connStatus.className = 'reconnecting'; if (isRemote && connectToId) setTimeout(() => connect(connectToId), 2000); });
  peer.on('disconnected', () => { ui.connStatus.className = 'reconnecting'; if(myId) peer.reconnect(); });
}
function connect(targetId) { if (conn) conn.close(); ui.connStatus.className = 'reconnecting'; conn = peer.connect(targetId, { reliable: true }); handleConnection(conn); }
function handleConnection(c) {
  conn = c; conn.on('open', () => { ui.connStatus.className = 'online'; if(!isRemote) setTimeout(sendSync, 500); });
  conn.on('data', (data) => {
    if (data.heartbeat) return;
    
    // SFX & FX RECEIVER (TV ONLY)
    if (!isRemote) {
        if (data.type === 'sfx') { playSoundEffect(data.key); return; }
        if (data.type === 'fx') { showFx(data.effect); return; }
        if (data.type === 'handout') { showHandoutTV(data.url); return; }
        if (data.type === 'float') { showFloatingText(data.target, data.val, data.isMana); return; }
    }

    if(data.jogadores) CONFIG.jogadores = data.jogadores;
    if(data.estado) { estadoAtual = data.estado; applyAudioState(); carregarCena(); }
    if(data.tvVisible !== undefined) tvVisible = data.tvVisible;
    if(data.dice && data.dice.id !== lastDiceRoll.id) { lastDiceRoll = data.dice; showDiceVisual(lastDiceRoll.val); }
    updateUI(false); salvarJogo(false);
  });
  conn.on('close', () => { ui.connStatus.className = 'reconnecting'; if (isRemote) setTimeout(() => connect(peerIdPrefix + roomName), 1000); });
}
function sendSync() { if(conn && conn.open) conn.send({ jogadores: CONFIG.jogadores, estado: estadoAtual, tvVisible: tvVisible, dice: lastDiceRoll }); salvarJogo(); }
function fullUpdate() { updateUI(); carregarCena(); sendSync(); }

/* --- DADOS --- */
function rolarD20() {
  if (isDiceRolling) return; isDiceRolling = true; document.getElementById("btn-dice-roll").disabled = true;
  if (navigator.vibrate) navigator.vibrate(50);
  const val = Math.floor(Math.random() * 20) + 1; lastDiceRoll = { val: val, id: Date.now() }; showDiceVisual(val); fullUpdate();
  setTimeout(() => { isDiceRolling = false; document.getElementById("btn-dice-roll").disabled = false; }, 2000);
}
function showDiceVisual(val) {
  ui.diceDisplay.innerText = val; ui.diceDisplay.style.color = val===20?"#2ecc71":(val===1?"#e74c3c":"#f1c40f");
  if(!isRemote) {
    const ov = ui.tvDiceOverlay; if(diceInterval) clearInterval(diceInterval); if(diceTimeout) clearTimeout(diceTimeout);
    ov.className = "rolling"; ov.style.opacity = "1"; ov.style.transform = "translate(-50%, -50%) scale(1)";
    diceInterval = setInterval(() => { ov.innerText = Math.floor(Math.random() * 20) + 1; }, 80);
    diceTimeout = setTimeout(() => {
        clearInterval(diceInterval); ov.innerText = val; ov.className = "impact";
        if(val === 20) ov.classList.add("crit-20"); else if(val === 1) ov.classList.add("crit-1"); else ov.classList.add("normal");
        diceTimeout = setTimeout(() => { ov.style.opacity = "0"; ov.style.transform = "translate(-50%, -50%) scale(0)"; }, 5000); 
    }, 2000); 
  }
}

/* --- LOGIC & FX SENDERS --- */
function btnAction(callback) { if(navigator.vibrate) navigator.vibrate(30); callback(); }
function mudarCenario(id) { btnAction(() => { estadoAtual.mapa = id; fullUpdate(); }); }
function mudarModo(id) { btnAction(() => { estadoAtual.modo = id; fullUpdate(); }); }
function toggleTvVisibility() { btnAction(() => { tvVisible = !tvVisible; fullUpdate(); }); }
function toggleHUDVisibility() { document.getElementById('hud-mestre').classList.toggle('oculto'); }
function toggleMusic() { btnAction(() => { estadoAtual.audio = !estadoAtual.audio; applyAudioState(); fullUpdate(); }); }

/* HANDOUTS & ENEMIES */
function showHandoutFromList() { const url = document.getElementById('sel-handout').value; sendHandout(url, 'carta'); }
function showEnemyFromList() { const url = document.getElementById('sel-enemy').value; sendHandout(url, 'inimigo'); }
function hideHandout() { if(conn && conn.open) conn.send({ type: 'handout', url: null }); }

function sendHandout(url, soundType) {
    if(conn && conn.open) {
        conn.send({ type: 'handout', url: url });
        if(url) conn.send({ type: 'sfx', key: soundType }); // Toca som
    }
}

function showHandoutTV(url) {
  if (url) { ui.handoutImg.src = url; ui.handoutLayer.classList.add("visivel"); } 
  else { ui.handoutLayer.classList.remove("visivel"); }
}

/* GLOBAL FX */
function triggerFx(effect) { 
    if(conn && conn.open) {
        conn.send({ type: 'fx', effect: effect }); 
        conn.send({ type: 'sfx', key: effect === 'shake' ? 'tremor' : 'flash' });
    }
    btnAction(()=>{}); 
}
function toggleBlood() { estadoAtual.blood = !estadoAtual.blood; fullUpdate(); }

function showFx(effect) {
  if (effect === 'flash') { ui.fxLayer.className = ""; void ui.fxLayer.offsetWidth; ui.fxLayer.classList.add("fx-flash"); }
  if (effect === 'shake') { document.body.classList.remove("fx-shake"); void document.body.offsetWidth; document.body.classList.add("fx-shake"); }
}

/* FLOATING TEXT LOGIC & SOUND TRIGGERS */
function sendFloat(idx, val, isMana=false) { 
    if(conn && conn.open) {
        conn.send({ type: 'float', target: idx, val: val, isMana: isMana });
        // Envia som apropriado
        if (isMana) conn.send({ type: 'sfx', key: 'mana' });
        else conn.send({ type: 'sfx', key: val > 0 ? 'cura' : 'dano' });
    }
}

function showFloatingText(targetIdx, val, isMana) {
  const card = document.getElementById(`tv-card-${targetIdx}`);
  if(!card) return;
  const el = document.createElement("div");
  el.className = "float-text " + (isMana ? "mana" : (val > 0 ? "heal" : "harm"));
  el.innerText = (val > 0 ? "+" : "") + val;
  card.appendChild(el);
  setTimeout(() => el.remove(), 1500);
}

/* SFX PLAYER */
function playSoundEffect(key) {
    const url = CONFIG.sfx[key];
    if (url && url !== "") {
        const audio = new Audio(url);
        audio.volume = 0.7; // Efeitos sonoros um pouco mais altos
        audio.play().catch(e => console.log("Erro SFX:", e));
    }
}

/* UI UPDATE */
function updateUI(propagate = true) {
  document.querySelectorAll('.btn-ctrl').forEach(b => { b.classList.remove('active', 'tv-active', 'music-on', 'music-off'); });
  if(document.getElementById('btn-map-' + estadoAtual.mapa)) document.getElementById('btn-map-' + estadoAtual.mapa).classList.add('active');
  if(document.getElementById('btn-mod-' + estadoAtual.modo)) document.getElementById('btn-mod-' + estadoAtual.modo).classList.add('active');
  if(tvVisible) document.getElementById('btn-tv-vis').classList.add('tv-active');
  
  const btnMusic = document.getElementById('btn-music');
  if(estadoAtual.audio) { btnMusic.classList.add('music-on'); btnMusic.innerText = "üéµ Som"; } else { btnMusic.classList.add('music-off'); btnMusic.innerText = "‚è∏Ô∏è Mudo"; }
  
  const btnBlood = document.getElementById('btn-blood');
  if(estadoAtual.blood) btnBlood.classList.add('blood-on'); else btnBlood.classList.remove('blood-on');

  if(!isRemote) { 
    if(tvVisible) ui.tvLayer.classList.add("visivel"); else ui.tvLayer.classList.remove("visivel"); 
    if(estadoAtual.blood) ui.fxLayer.classList.add("fx-blood"); else ui.fxLayer.classList.remove("fx-blood");
  }

  const dl = document.getElementById('lista-classes');
  if(dl) dl.innerHTML = CONFIG.classesPadrao.map(c => `<option value="${c}">`).join('');

  ui.mestreList.innerHTML = ""; Object.values(ui.zones).forEach(z => z.innerHTML = "");
  CONFIG.jogadores.forEach((char, idx) => {
    const pct = Math.max(0, Math.min(100, (char.hpAtual / char.hpMax) * 100));
    const pctMp = Math.max(0, Math.min(100, (char.mpAtual / char.mpMax) * 100));
    let cor = "hp-verde"; if (pct < 50) cor = "hp-amarelo"; if (pct < 20) cor = "hp-vermelho"; if (char.hpAtual <= 0) cor = "hp-morto";
    const statusObj = CONFIG.listaStatus.find(s => s.valor === char.status);
    const statusTxt = statusObj ? statusObj.label : "";

    const mCard = document.createElement("div");
    mCard.className = "mestre-card"; mCard.setAttribute("data-status", char.status);
    let stOpts = ""; CONFIG.listaStatus.forEach(s => stOpts += `<option value="${s.valor}" ${char.status===s.valor?'selected':''}>${s.label}</option>`);
    const pSul=char.posicao==="sul"?"selected":"", pNorte=char.posicao==="norte"?"selected":"", pLeste=char.posicao==="leste"?"selected":"", pOeste=char.posicao==="oeste"?"selected":"";

    mCard.innerHTML = `
      <div class="card-top"><input type="text" class="input-nome" value="${char.nome}" onchange="edit(${idx},'nome',this.value)"><button class="btn-delete" onclick="remover(${idx})">‚úï</button></div>
      <input type="text" class="input-classe" list="lista-classes" value="${char.classe}" onchange="edit(${idx},'classe',this.value)">
      <div class="bar-container">
        <div class="status-text-row"><span>PV: ${Math.ceil(char.hpAtual)}/${char.hpMax}</span></div>
        <div class="hp-bar-bg"><div class="hp-bar-fill ${cor}" style="width:${pct}%"></div></div>
        <div class="status-text-row"><span>MP: ${Math.ceil(char.mpAtual)}/${char.mpMax}</span></div>
        <div class="mp-bar-bg"><div class="mp-bar-fill" style="width:${pctMp}%"></div></div>
      </div>
      <div class="card-actions"><button class="btn-dmg harm" onclick="hp(${idx},-5)">-5</button><button class="btn-dmg harm" onclick="hp(${idx},-1)">-1</button><button class="btn-dmg heal" onclick="hp(${idx},1)">+1</button><button class="btn-dmg heal" onclick="hp(${idx},5)">+5</button></div>
      <div class="card-actions"><button class="btn-dmg mana-sub" onclick="mp(${idx},-5)">MP-5</button><button class="btn-dmg mana-sub" onclick="mp(${idx},-1)">MP-1</button><button class="btn-dmg mana-add" onclick="mp(${idx},1)">MP+1</button><button class="btn-dmg mana-add" onclick="mp(${idx},5)">MP+5</button></div>
      <div class="card-settings"><select class="select-style" onchange="st(${idx},this.value)">${stOpts}</select><select class="select-style" onchange="edit(${idx},'posicao',this.value)"><option value="sul" ${pSul}>Sul</option><option value="norte" ${pNorte}>Norte</option><option value="leste" ${pLeste}>Leste</option><option value="oeste" ${pOeste}>Oeste</option></select></div>
    `;
    ui.mestreList.appendChild(mCard);

    if(!isRemote) {
      const tCard = document.createElement("div"); tCard.className = "tv-card"; tCard.setAttribute("data-status", char.status);
      tCard.id = `tv-card-${idx}`;
      tCard.innerHTML = `
        <div class="tv-name">${char.nome}</div>
        <div style="font-size:12px;color:#aaa;text-transform:uppercase;margin-bottom:5px;">${char.classe}</div>
        <div class="tv-vals"><span class="tv-hp-val">PV ${Math.ceil(char.hpAtual)}</span><span class="tv-mp-val">MP ${Math.ceil(char.mpAtual)}</span></div>
        <div class="hp-bar-bg" style="height:12px;margin:0 0 4px 0;"><div class="hp-bar-fill ${cor}" style="width:${pct}%"></div></div>
        <div class="mp-bar-bg" style="height:8px;margin:0 0 10px 0;"><div class="mp-bar-fill" style="width:${pctMp}%"></div></div>
        <div class="tv-status">${statusTxt}</div>
      `;
      (ui.zones[char.posicao] || ui.zones.sul).appendChild(tCard);
    }
  });
}

window.hp=(idx,val)=>{const c=CONFIG.jogadores[idx];c.hpAtual+=val;if(c.hpAtual>c.hpMax)c.hpAtual=c.hpMax;if(c.hpAtual<0)c.hpAtual=0;const pct=(c.hpAtual/c.hpMax)*100;if(c.hpAtual<=0){c.status="caido";}else{const l=["","cansado","critico","caido"];if(l.includes(c.status)){if(pct<20)c.status="critico";else if(pct<50)c.status="cansado";else c.status="";}} sendFloat(idx, val, false); fullUpdate();}
window.mp=(idx,val)=>{const c=CONFIG.jogadores[idx];c.mpAtual+=val;if(c.mpAtual>c.mpMax)c.mpAtual=c.mpMax;if(c.mpAtual<0)c.mpAtual=0; sendFloat(idx, val, true); fullUpdate();}
window.st=(idx,val)=>{CONFIG.jogadores[idx].status=val;fullUpdate();}
window.edit=(idx,f,v)=>{CONFIG.jogadores[idx][f]=v;fullUpdate();}
window.adicionarJogador=()=>{CONFIG.jogadores.push({nome:"Novo",classe:"Heroi",hpMax:30,hpAtual:30,mpMax:10,mpAtual:10,status:"",posicao:"sul"});fullUpdate();}
window.remover=(idx)=>{if(confirm("Excluir?")){CONFIG.jogadores.splice(idx,1);fullUpdate();}}
window.toggleEdicao=()=>{modoEdicao=!modoEdicao;ui.btnEdit.classList.toggle("ativo");document.getElementById("hud-mestre").classList.toggle("modo-edicao");}

function applyAudioState() {
  if (isRemote) return;
  const active = faixaAtiva === 'A' ? ui.faixaA : ui.faixaB;
  if (!estadoAtual.audio) fadeOutAndPause(active); else if (active.src && active.paused) fadeInAndPlay(active);
}
function fadeOutAndPause(audio) {
  if(audio.fadeInt) clearInterval(audio.fadeInt);
  audio.fadeInt = setInterval(() => { if(audio.volume > 0.05) audio.volume -= 0.05; else { audio.volume = 0; audio.pause(); clearInterval(audio.fadeInt); } }, 50);
}
function fadeInAndPlay(audio) {
  audio.volume = 0; audio.play().catch(()=>{});
  if(audio.fadeInt) clearInterval(audio.fadeInt);
  audio.fadeInt = setInterval(() => { if(audio.volume < CONFIG.volume - 0.05) audio.volume += 0.05; else { audio.volume = CONFIG.volume; clearInterval(audio.fadeInt); } }, 50);
}
function audioCrossfade(urlNovo) {
  if(urlNovo === trilhaAtualUrl) return; trilhaAtualUrl = urlNovo;
  const ent = faixaAtiva === 'A' ? ui.faixaB : ui.faixaA;
  const sai = faixaAtiva === 'A' ? ui.faixaA : ui.faixaB;
  faixaAtiva = faixaAtiva === 'A' ? 'B' : 'A';
  ent.src = urlNovo; ent.volume = 0; 
  if (estadoAtual.audio) ent.play().catch(()=>{});
  let vol = 0; if(window.fadeInt) clearInterval(window.fadeInt);
  window.fadeInt = setInterval(() => {
    vol += 0.05; if(vol >= CONFIG.volume) { if (estadoAtual.audio) ent.volume = CONFIG.volume; sai.volume = 0; sai.pause(); clearInterval(window.fadeInt); }
    else { if (estadoAtual.audio) ent.volume = vol; sai.volume = Math.max(0, CONFIG.volume - vol); }
  }, 100);
}

function carregarCena() {
  if(isRemote) return; 
  const mapaConf = CONFIG.mapas[estadoAtual.mapa]; 
  if(!mapaConf) return;
  const urlImg = mapaConf.img[estadoAtual.modo];
  if (urlImg) { const img = new Image(); img.src = urlImg; img.onload = () => { ui.visual.style.backgroundImage = `url('${urlImg}')`; }; }
  const urlAudio = mapaConf.audio[estadoAtual.modo];
  if (urlAudio && urlAudio !== "") audioCrossfade(urlAudio);
}

function salvarJogo(save=true) { if(save) localStorage.setItem(CONFIG.saveKey, JSON.stringify(CONFIG.jogadores)); }
function carregarJogo() { const s = localStorage.getItem(CONFIG.saveKey); if(s) try{CONFIG.jogadores=JSON.parse(s)}catch(e){} }
window.resetarJogo = () => { if(confirm("Reset?")) { localStorage.removeItem(CONFIG.saveKey); location.reload(); } };
window.toggleHUDVisibility = () => { document.getElementById('hud-mestre').classList.toggle('oculto'); };

document.addEventListener("keydown", (e) => {
  if (e.target.tagName === "INPUT" || e.target.tagName === "SELECT") return;
  const key = e.key.toLowerCase();
  if (key === 'h') { e.preventDefault(); if(!isRemote) toggleHUDVisibility(); }
  if(!isRemote) {
    if(CONFIG.mapas[key]) mudarCenario(key);
    if(CONFIG.estados[key]) mudarModo(key);
    if(key === 't') toggleTvVisibility();
  }
});
</script>
</body>

</html>
